// Enhanced IT Helpdesk Database Schema
// Includes: Auth.js, RBAC, Audit Logging, Notifications, Attachments
// Version: 2.0 (Enhanced)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========================================
// AUTHENTICATION & AUTHORIZATION (Auth.js)
// ========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String? // Hashed password for credentials provider

  // Profile Information
  firstName    String? @map("first_name") @db.VarChar(50)
  lastName     String? @map("last_name") @db.VarChar(50)
  phone        String? @db.VarChar(20)
  jobTitle     String? @map("job_title") @db.VarChar(100)
  departmentId String? @map("department_id")

  // Status & Metadata
  isActive    Boolean   @default(true) @map("is_active")
  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at") // Soft delete

  // Relations
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  accounts   Account[]
  sessions   Session[]
  userRoles  UserRole[]

  // Helpdesk Relations
  equipmentAssignments Equipment[]
  problemsAsReporter   Problem[]             @relation("ProblemReporter")
  problemsAsOperator   Problem[]             @relation("ProblemOperator")
  problemsAsSpecialist Problem[]             @relation("ProblemSpecialist")
  callsAsReporter      Call[]                @relation("CallReporter")
  callsAsOperator      Call[]                @relation("CallOperator")
  resolutions          Resolution[]
  specialistExpertise  SpecialistExpertise[]

  // Activity & Notifications
  activityLogs  ActivityLog[]
  notifications Notification[]
  attachments   Attachment[]

  @@index([email])
  @@index([departmentId])
  @@index([isActive])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ========================================
// ROLE-BASED ACCESS CONTROL (RBAC)
// ========================================

model Role {
  id          String  @id @default(cuid())
  name        String  @unique @db.VarChar(50)
  description String? @db.Text
  isSystem    Boolean @default(false) @map("is_system") // System roles cannot be deleted

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userRoles   UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String  @id @default(cuid())
  name        String  @unique @db.VarChar(100)
  description String? @db.Text
  resource    String  @db.VarChar(50) // e.g., "problems", "staff", "equipment"
  action      String  @db.VarChar(50) // e.g., "create", "read", "update", "delete"

  createdAt DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model UserRole {
  id     String @id @default(cuid())
  userId String @map("user_id")
  roleId String @map("role_id")

  assignedAt DateTime  @default(now()) @map("assigned_at")
  assignedBy String?   @map("assigned_by")
  expiresAt  DateTime? @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  grantedAt DateTime @default(now()) @map("granted_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ========================================
// AUDIT LOGGING & ACTIVITY TRACKING
// ========================================

model ActivityLog {
  id          String  @id @default(cuid())
  userId      String? @map("user_id")
  action      String  @db.VarChar(100) // e.g., "problem.created", "user.login"
  resource    String? @db.VarChar(50) // e.g., "Problem", "User"
  resourceId  String? @map("resource_id")
  description String? @db.Text
  metadata    Json? // Additional context (old values, new values, etc.)
  ipAddress   String? @map("ip_address") @db.VarChar(45)
  userAgent   String? @map("user_agent") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ========================================
// DEPARTMENTS
// ========================================

model Department {
  id        String  @id @default(cuid())
  name      String  @unique @map("department_name") @db.VarChar(100)
  location  String? @map("department_location") @db.VarChar(100)
  managerId String? @map("manager_id")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  users User[]

  @@index([isActive])
  @@map("departments")
}

// ========================================
// EQUIPMENT MANAGEMENT
// ========================================

model Equipment {
  id               String          @id @default(cuid())
  serialNumber     String          @unique @map("serial_number") @db.VarChar(100)
  assetTag         String?         @unique @map("asset_tag") @db.VarChar(50)
  equipmentType    String          @map("equipment_type") @db.VarChar(50)
  equipmentMake    String          @map("equipment_make") @db.VarChar(50)
  equipmentModel   String?         @map("equipment_model") @db.VarChar(100)
  purchaseDate     DateTime?       @map("purchase_date") @db.Date
  warrantyExpiry   DateTime?       @map("warranty_expiry") @db.Date
  assignedToUserId String?         @map("assigned_to_user_id")
  locationDetails  String?         @map("location_details") @db.VarChar(255)
  status           EquipmentStatus @default(active)
  notes            String?         @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  assignedToUser    User?               @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)
  equipmentSoftware EquipmentSoftware[]
  problems          Problem[]

  @@index([serialNumber])
  @@index([assetTag])
  @@index([assignedToUserId])
  @@index([status])
  @@map("equipment")
}

enum EquipmentStatus {
  active
  retired
  repair
  maintenance
  lost
}

model OperatingSystem {
  id          String  @id @default(cuid())
  name        String  @map("os_name") @db.VarChar(100)
  version     String  @map("os_version") @db.VarChar(50)
  vendor      String? @map("os_vendor") @db.VarChar(50)
  isSupported Boolean @default(true) @map("is_supported")

  createdAt DateTime @default(now()) @map("created_at")

  equipmentSoftware EquipmentSoftware[]

  @@unique([name, version], name: "unique_os")
  @@map("operating_systems")
}

model Software {
  id       String  @id @default(cuid())
  name     String  @map("software_name") @db.VarChar(100)
  version  String  @map("software_version") @db.VarChar(50)
  vendor   String? @map("software_vendor") @db.VarChar(100)
  category String? @map("software_category") @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at")

  licenses          License[]
  equipmentSoftware EquipmentSoftware[]

  @@unique([name, version], name: "unique_software")
  @@map("software")
}

model License {
  id           String      @id @default(cuid())
  softwareId   String      @map("software_id")
  licenseKey   String?     @unique @map("license_key") @db.VarChar(255)
  purchaseDate DateTime?   @map("purchase_date") @db.Date
  expiryDate   DateTime?   @map("expiry_date") @db.Date
  licenseType  LicenseType @map("license_type")
  maxUsers     Int         @default(1) @map("max_users")
  isValid      Boolean     @default(true) @map("is_valid")
  notes        String?     @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  software          Software            @relation(fields: [softwareId], references: [id], onDelete: Cascade)
  equipmentSoftware EquipmentSoftware[]

  @@index([softwareId])
  @@index([expiryDate])
  @@map("licenses")
}

enum LicenseType {
  perpetual
  subscription
  trial
  open_source
}

model EquipmentSoftware {
  id               String    @id @default(cuid())
  equipmentId      String    @map("equipment_id")
  softwareId       String?   @map("software_id")
  osId             String?   @map("os_id")
  licenseId        String?   @map("license_id")
  installationDate DateTime? @map("installation_date") @db.Date
  notes            String?   @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  equipment Equipment        @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  software  Software?        @relation(fields: [softwareId], references: [id], onDelete: Cascade)
  os        OperatingSystem? @relation(fields: [osId], references: [id], onDelete: SetNull)
  license   License?         @relation(fields: [licenseId], references: [id], onDelete: SetNull)

  @@index([equipmentId])
  @@index([softwareId])
  @@map("equipment_software")
}

// ========================================
// PROBLEM TYPES & EXPERTISE
// ========================================

model ProblemType {
  id                  String  @id @default(cuid())
  name                String  @unique @map("problem_type_name") @db.VarChar(100)
  description         String? @map("problem_description") @db.Text
  parentProblemTypeId String? @map("parent_problem_type_id")
  slaResponseTime     Int?    @map("sla_response_time") // in minutes
  slaResolutionTime   Int?    @map("sla_resolution_time") // in minutes
  isActive            Boolean @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  parentProblemType   ProblemType?          @relation("ProblemTypeHierarchy", fields: [parentProblemTypeId], references: [id], onDelete: SetNull)
  childProblemTypes   ProblemType[]         @relation("ProblemTypeHierarchy")
  problems            Problem[]
  specialistExpertise SpecialistExpertise[]

  @@index([parentProblemTypeId])
  @@index([isActive])
  @@map("problem_types")
}

model SpecialistExpertise {
  id             String         @id @default(cuid())
  specialistId   String         @map("specialist_id")
  problemTypeId  String         @map("problem_type_id")
  expertiseLevel ExpertiseLevel @default(intermediate) @map("expertise_level")

  createdAt DateTime @default(now()) @map("created_at")

  specialist  User        @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  problemType ProblemType @relation(fields: [problemTypeId], references: [id], onDelete: Cascade)

  @@unique([specialistId, problemTypeId], name: "unique_specialist_expertise")
  @@index([specialistId])
  @@index([problemTypeId])
  @@map("specialist_expertise")
}

enum ExpertiseLevel {
  beginner
  intermediate
  expert
}

// ========================================
// PROBLEMS / TICKETS
// ========================================

model Problem {
  id                   String        @id @default(cuid())
  problemNumber        String        @unique @map("problem_number") @db.VarChar(50)
  title                String        @db.VarChar(255)
  description          String?       @db.Text
  reporterId           String        @map("reporter_id")
  equipmentId          String?       @map("equipment_id")
  problemTypeId        String?       @map("problem_type_id")
  initialOperatorId    String?       @map("initial_operator_id")
  assignedSpecialistId String?       @map("assigned_specialist_id")
  priority             Priority      @default(medium)
  status               ProblemStatus @default(open)

  // SLA Tracking
  slaResponseDue   DateTime? @map("sla_response_due")
  slaResolutionDue DateTime? @map("sla_resolution_due")
  slaBreached      Boolean   @default(false) @map("sla_breached")

  // Timestamps
  reportedAt DateTime  @default(now()) @map("reported_at")
  assignedAt DateTime? @map("assigned_at")
  resolvedAt DateTime? @map("resolved_at")
  closedAt   DateTime? @map("closed_at")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  reporter           User         @relation("ProblemReporter", fields: [reporterId], references: [id], onDelete: Restrict)
  equipment          Equipment?   @relation(fields: [equipmentId], references: [id], onDelete: SetNull)
  problemType        ProblemType? @relation(fields: [problemTypeId], references: [id], onDelete: SetNull)
  initialOperator    User?        @relation("ProblemOperator", fields: [initialOperatorId], references: [id], onDelete: SetNull)
  assignedSpecialist User?        @relation("ProblemSpecialist", fields: [assignedSpecialistId], references: [id], onDelete: SetNull)

  calls         Call[]
  resolution    Resolution?
  statusHistory ProblemStatusHistory[]
  attachments   Attachment[]
  notifications Notification[]

  @@index([problemNumber])
  @@index([reporterId])
  @@index([status])
  @@index([priority])
  @@index([assignedSpecialistId])
  @@index([createdAt])
  @@index([slaResolutionDue])
  @@map("problems")
}

enum Priority {
  low
  medium
  high
  critical
}

enum ProblemStatus {
  open
  assigned
  in_progress
  awaiting_user
  resolved
  closed
  cancelled
}

// Track status changes for audit
model ProblemStatusHistory {
  id           String         @id @default(cuid())
  problemId    String         @map("problem_id")
  oldStatus    ProblemStatus? @map("old_status")
  newStatus    ProblemStatus  @map("new_status")
  changedBy    String         @map("changed_by")
  changeReason String?        @map("change_reason") @db.Text

  changedAt DateTime @default(now()) @map("changed_at")

  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([problemId])
  @@index([changedAt])
  @@map("problem_status_history")
}

// ========================================
// CALLS & INTERACTIONS
// ========================================

model Call {
  id               String   @id @default(cuid())
  problemId        String   @map("problem_id")
  reporterId       String   @map("reporter_id")
  operatorId       String   @map("operator_id")
  callDatetime     DateTime @default(now()) @map("call_datetime")
  callType         CallType @map("call_type")
  callNotes        String   @map("call_notes") @db.Text
  callDescription  String?  @map("call_description") @db.Text
  callDurationMins Int?     @map("call_duration_minutes")

  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  problem  Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  reporter User    @relation("CallReporter", fields: [reporterId], references: [id], onDelete: Restrict)
  operator User    @relation("CallOperator", fields: [operatorId], references: [id], onDelete: Restrict)

  @@index([problemId])
  @@index([callDatetime])
  @@map("calls")
}

enum CallType {
  initial
  follow_up
  update
  closure
}

// ========================================
// RESOLUTIONS
// ========================================

model Resolution {
  id                    String   @id @default(cuid())
  problemId             String   @unique @map("problem_id")
  resolvedByUserId      String   @map("resolved_by_user_id")
  resolutionDatetime    DateTime @map("resolution_datetime")
  resolutionDescription String   @map("resolution_description") @db.Text
  resolutionNotes       String?  @map("resolution_notes") @db.Text
  timeTakenHours        Decimal? @map("time_taken_hours") @db.Decimal(10, 2)
  wasSuccessful         Boolean  @default(true) @map("was_successful")

  // User Feedback
  userSatisfaction Int?    @map("user_satisfaction") @db.TinyInt // 1-5 rating
  userFeedback     String? @map("user_feedback") @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  problem        Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  resolvedByUser User    @relation(fields: [resolvedByUserId], references: [id], onDelete: Restrict)

  @@index([resolutionDatetime])
  @@map("resolutions")
}

// ========================================
// ATTACHMENTS & FILES
// ========================================

model Attachment {
  id          String  @id @default(cuid())
  problemId   String? @map("problem_id")
  uploadedBy  String  @map("uploaded_by")
  fileName    String  @map("file_name") @db.VarChar(255)
  fileSize    Int     @map("file_size") // in bytes
  mimeType    String  @map("mime_type") @db.VarChar(100)
  fileUrl     String  @map("file_url") @db.VarChar(500)
  description String? @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  problem Problem? @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [uploadedBy], references: [id], onDelete: Restrict)

  @@index([problemId])
  @@index([uploadedBy])
  @@map("attachments")
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  problemId String?          @map("problem_id")
  type      NotificationType
  title     String           @db.VarChar(255)
  message   String           @db.Text
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")

  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem Problem? @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  problem_assigned
  problem_updated
  problem_resolved
  problem_closed
  sla_warning
  sla_breached
  mention
  system
}

// ========================================
// SYSTEM SETTINGS
// ========================================

model SystemSetting {
  id          String  @id @default(cuid())
  key         String  @unique @db.VarChar(100)
  value       String  @db.Text
  description String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}
